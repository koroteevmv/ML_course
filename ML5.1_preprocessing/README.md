### Предварительная обработка данных.

#### Цель работы

Познакомиться с основными приемами предварительной обработки и очистки данных.

#### Задания для выполнения


1. Загрузите и прочитайте в pandas следующий [датасет](https://github.com/koroteevmv/ML_course/blob/main/ML4.1/data/cars_sampled.csv). Обратите внимание, что датасет собран «криво», поэтому прежде чем он «правильно» загрузится (рис.1), необходимо его обработать.
2. Сделайте описательную статистику: размер, типы переменных, пустые значения, уникальные имена и т.д.
3. Поработайте с типами переменных. Все числовые значения переведите в формат int.
4. Поработайте со столбцом price. Постройте гистограмму, найдите выбросы (ящиковая диаграмма), удалите аномальные значения, постарайтесь привести к нормальному распределению.
5. Аналогично поработайте и с другими «важными для целевой функции price» параметрами (powerPS, yearOfRegistration, kilometer и т.д). «Важность» докажите через коэффициент корреляции. Сделайте визуализацию.
6. Постройте ящиковые диаграммы зависимости gearbox, fuelType, vehicleType, notRepairedDamage от price. Сделайте выводы. Можно ли убрать значения с малой частотой? Повлияет ли это на дальнейшее исследование?
7. Найдите пропуски. Удалите столбцы, которые содержат большое количество пропусков. В остальных случаях постарайтесь восстановить пропущенные значения.
8. Сохраните полученный датасет и выведете его.

#### Методические указания

Реальные данные, используемые для машинного обучения на практике могут происходить из различных источников и содержать в себе ошибки. Эти ошибки - это следствие человеческого фактора, багов в программах обработки данных, неполноты данных в источниках, и множества других причин. Для эффективного использования данных такие ошибки нужно исправить. 

Для иллюстрации наиболее распространенных ошибок в данных давайте возьмем фрагмент датасета из задачи про кредитный скоринг:

<table>
  <tr>
   <td>Пол
   </td>
   <td>Возраст
   </td>
   <td>Город
   </td>
   <td>Доход
   </td>
   <td>Образование
   </td>
   <td>Вернул?
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>25
   </td>
   <td>Мск
   </td>
   <td>70000
   </td>
   <td>A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>31
   </td>
   <td>Мск
   </td>
   <td>100000000
   </td>
   <td>C
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>10
   </td>
   <td>Мск
   </td>
   <td>40000
   </td>
   <td>C
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>А
   </td>
   <td>28
   </td>
   <td>СПб
   </td>
   <td>80000
   </td>
   <td>B
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>23
   </td>
   <td>
   </td>
   <td>40000
   </td>
   <td>A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>30
   </td>
   <td>
    Екб
   </td>
   <td>19973
   </td>
   <td>B
   </td>
   <td>1
   </td>
  </tr>
</table>

В этом небольшом участке видно сразу несколько несостыковок. Например, сразу же в первом столбце присутствует аномальное значение:

<table>
  <tr>
   <td>Пол
   </td>
   <td>Возраст
   </td>
   <td>Город
   </td>
   <td>Доход
   </td>
   <td>Образование
   </td>
   <td>Вернул?
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>25
   </td>
   <td>Мск
   </td>
   <td>70000
   </td>
   <td>A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>31
   </td>
   <td>Мск
   </td>
   <td>100000000
   </td>
   <td>C
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>10
   </td>
   <td>Мск
   </td>
   <td>40000
   </td>
   <td>C
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>А
   </td>
   <td>28
   </td>
   <td>СПб
   </td>
   <td>80000
   </td>
   <td>B
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>23
   </td>
   <td>
   </td>
   <td>40000
   </td>
   <td>A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>30
   </td>
   <td>
    Екб
   </td>
   <td>19973
   </td>
   <td>B
   </td>
   <td>1
   </td>
  </tr>
</table>

Далее, во втором столбце 10 - это тоже, скорее всего, неправильное значение. Вряд ли десятилетний ребенок обращался в банк за кредитом:

<table>
  <tr>
   <td>Пол
   </td>
   <td>Возраст
   </td>
   <td>Город
   </td>
   <td>Доход
   </td>
   <td>Образование
   </td>
   <td>Вернул?
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>25
   </td>
   <td>Мск
   </td>
   <td>70000
   </td>
   <td>A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>31
   </td>
   <td>Мск
   </td>
   <td>100000000
   </td>
   <td>C
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>10
   </td>
   <td>Мск
   </td>
   <td>40000
   </td>
   <td>C
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>А
   </td>
   <td>28
   </td>
   <td>СПб
   </td>
   <td>80000
   </td>
   <td>B
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>23
   </td>
   <td>
   </td>
   <td>40000
   </td>
   <td>A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>30
   </td>
   <td>
    Екб
   </td>
   <td>19973
   </td>
   <td>B
   </td>
   <td>1
   </td>
  </tr>
</table>

Переходим к третьему столбцу. Здесь все еще очевиднее. В одной из строк значение просто отсутствует. Наверное, его просто забыли внести при заполнении форм, или оно потерялось в процессе преобразования. Для большинства алгоритмов машинного обучения отсутствующие значения недопустимы. Поэтому этот пробел надо будет чем-то заполнить:

<table>
  <tr>
   <td>Пол
   </td>
   <td>Возраст
   </td>
   <td>Город
   </td>
   <td>Доход
   </td>
   <td>Образование
   </td>
   <td>Вернул?
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>25
   </td>
   <td>Мск
   </td>
   <td>70000
   </td>
   <td>A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>31
   </td>
   <td>Мск
   </td>
   <td>100000000
   </td>
   <td>C
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>10
   </td>
   <td>Мск
   </td>
   <td>40000
   </td>
   <td>C
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>А
   </td>
   <td>28
   </td>
   <td>СПб
   </td>
   <td>80000
   </td>
   <td>B
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>23
   </td>
   <td>?
   </td>
   <td>40000
   </td>
   <td>A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>30
   </td>
   <td>
    Екб
   </td>
   <td>19973
   </td>
   <td>B
   </td>
   <td>1
   </td>
  </tr>
</table>

В четвертом столбце тоже не все чисто. Присутствует аномально высокое значение. Непонятно даже, откуда оно взялось. Может быть это ошибка, а может быть, какое-то специальное значение (типа MAXINT). Вообще, это может быть просто выбросом, то есть корректным значением, но нехарактерно далеким от среднего. Ведь миллиардеры тоже могут брать кредиты.

<table>
  <tr>
   <td>Пол
   </td>
   <td>Возраст
   </td>
   <td>Город
   </td>
   <td>Доход
   </td>
   <td>Образование
   </td>
   <td>Вернул?
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>25
   </td>
   <td>Мск
   </td>
   <td>70000
   </td>
   <td>A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>31
   </td>
   <td>Мск
   </td>
   <td>100000000
   </td>
   <td>C
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>10
   </td>
   <td>Мск
   </td>
   <td>40000
   </td>
   <td>C
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>А
   </td>
   <td>28
   </td>
   <td>СПб
   </td>
   <td>80000
   </td>
   <td>B
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>23
   </td>
   <td>
   </td>
   <td>40000
   </td>
   <td>A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>30
   </td>
   <td>
    Екб
   </td>
   <td>19973
   </td>
   <td>B
   </td>
   <td>1
   </td>
  </tr>
</table>

Если присмотреться, в этом же столбце есть еще одно подозрительное место. Обратите внимание, что все значения здесь приведены в десятках тысяч. Однако одно конкретное значение приведено с нехарактерной точностью:

<table>
  <tr>
   <td>Пол
   </td>
   <td>Возраст
   </td>
   <td>Город
   </td>
   <td>Доход
   </td>
   <td>Образование
   </td>
   <td>Вернул?
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>25
   </td>
   <td>Мск
   </td>
   <td>70000
   </td>
   <td>A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>31
   </td>
   <td>Мск
   </td>
   <td>100000000
   </td>
   <td>C
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>10
   </td>
   <td>Мск
   </td>
   <td>40000
   </td>
   <td>C
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>А
   </td>
   <td>28
   </td>
   <td>СПб
   </td>
   <td>80000
   </td>
   <td>B
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>23
   </td>
   <td>
   </td>
   <td>40000
   </td>
   <td>A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>30
   </td>
   <td>
    Екб
   </td>
   <td>19973
   </td>
   <td>B
   </td>
   <td>1
   </td>
  </tr>
</table>

Перейдем к последнему признаку. Здесь вообще без пояснения шкалы непонятно, что эти буквы означают. Самый главный вопрос: можно ли их сравнивать, то есть установлено ли у этого признака отношение порядка. Ведь если это уровень образования (начальный, средний, высший), то их можно представить как числа. А если это направление (техническое, гуманитарное, естественное), то нужно к этому признаку относиться как к категориальному.

<table>
  <tr>
   <td>Пол
   </td>
   <td>Возраст
   </td>
   <td>Город
   </td>
   <td>Доход
   </td>
   <td>Образование
   </td>
   <td>Вернул?
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>25
   </td>
   <td>Мск
   </td>
   <td>70000
   </td>
   <td>A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>31
   </td>
   <td>Мск
   </td>
   <td>100000000
   </td>
   <td>C
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>10
   </td>
   <td>Мск
   </td>
   <td>40000
   </td>
   <td>C
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>А
   </td>
   <td>28
   </td>
   <td>СПб
   </td>
   <td>80000
   </td>
   <td>B
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>23
   </td>
   <td>
   </td>
   <td>40000
   </td>
   <td>A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>30
   </td>
   <td>
    Екб
   </td>
   <td>19973
   </td>
   <td>B
   </td>
   <td>1
   </td>
  </tr>
</table>

Итого в нашем фрагменте несколько сомнительных значений, которые лучше удалить и заполнять более правдоподобными:

<table>
  <tr>
   <td>Пол
   </td>
   <td>Возраст
   </td>
   <td>Город
   </td>
   <td>Доход
   </td>
   <td>Образование
   </td>
   <td>Вернул?
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>25
   </td>
   <td>Мск
   </td>
   <td>70000
   </td>
   <td>A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>31
   </td>
   <td>Мск
   </td>
   <td>?
   </td>
   <td>C
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>10
   </td>
   <td>Мск
   </td>
   <td>40000
   </td>
   <td>C
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>
    ?
   </td>
   <td>28
   </td>
   <td>СПб
   </td>
   <td>80000
   </td>
   <td>B
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>23
   </td>
   <td>?
   </td>
   <td>40000
   </td>
   <td>A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>30
   </td>
   <td>
    Екб
   </td>
   <td>19973
   </td>
   <td>B
   </td>
   <td>1
   </td>
  </tr>
</table>

Отсутствующие значения в числовых признаках чаще всего заменяют на среднее значение по этому признаку. Это дает наименьшее отклонение от изначального распределения признака:

<table>
  <tr>
   <td>Пол
   </td>
   <td>Возраст
   </td>
   <td>Город
   </td>
   <td>Доход
   </td>
   <td>Образование
   </td>
   <td>Вернул?
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>25
   </td>
   <td>Мск
   </td>
   <td>70000
   </td>
   <td>
    A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>31
   </td>
   <td>Мск
   </td>
   <td>49994.6
   </td>
   <td>
    C
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>10
   </td>
   <td>Мск
   </td>
   <td>40000
   </td>
   <td>
    C
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>
    ?
   </td>
   <td>28
   </td>
   <td>СПб
   </td>
   <td>80000
   </td>
   <td>B
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>23
   </td>
   <td>?
   </td>
   <td>40000
   </td>
   <td>
    A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>30
   </td>
   <td>
    Екб
   </td>
   <td>19973
   </td>
   <td>B
   </td>
   <td>1
   </td>
  </tr>
</table>

Хотя иногда используют не среднее арифметическое, а медианное значение:

<table>
  <tr>
   <td>Пол
   </td>
   <td>Возраст
   </td>
   <td>Город
   </td>
   <td>Доход
   </td>
   <td>Образование
   </td>
   <td>Вернул?
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>25
   </td>
   <td>Мск
   </td>
   <td>70000
   </td>
   <td>A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>31
   </td>
   <td>Мск
   </td>
   <td>40000
   </td>
   <td>C
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>10
   </td>
   <td>Мск
   </td>
   <td>40000
   </td>
   <td>C
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>
    ?
   </td>
   <td>28
   </td>
   <td>СПб
   </td>
   <td>80000
   </td>
   <td>B
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>23
   </td>
   <td>?
   </td>
   <td>40000
   </td>
   <td>A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>30
   </td>
   <td>
    Екб
   </td>
   <td>19973
   </td>
   <td>B
   </td>
   <td>1
   </td>
  </tr>
</table>

Пропуски в категориальных признаках можно заменять на наиболее популярное (модальное) значение:

<table>
  <tr>
   <td>Пол
   </td>
   <td>Возраст
   </td>
   <td>Город
   </td>
   <td>Доход
   </td>
   <td>Образование
   </td>
   <td>Вернул?
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>25
   </td>
   <td>Мск
   </td>
   <td>70000
   </td>
   <td>A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>31
   </td>
   <td>Мск
   </td>
   <td>?
   </td>
   <td>C
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>10
   </td>
   <td>Мск
   </td>
   <td>40000
   </td>
   <td>C
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>28
   </td>
   <td>СПб
   </td>
   <td>80000
   </td>
   <td>B
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>23
   </td>
   <td>Мск
   </td>
   <td>40000
   </td>
   <td>A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>30
   </td>
   <td>
    Екб
   </td>
   <td>19973
   </td>
   <td>B
   </td>
   <td>1
   </td>
  </tr>
</table>

Хотя, если пропусков довольно много, то такая замена сильно сместит распределение к центру. Поэтому довольно часто пропуски в категориальных переменных заполняют специальным значением, обозначающим отсутствие значения. Потом, когда мы будем кодировать этот признак, это приведет к созданию еще одной фиктивной переменной. Такой способ сохраняет наибольшее количество информации из исходного набора данных. Он даже может учитывать, если сам пропуск несет какую-то смысловую нагрузку.

<table>
  <tr>
   <td>Пол
   </td>
   <td>Возраст
   </td>
   <td>Город
   </td>
   <td>Доход
   </td>
   <td>Образование
   </td>
   <td>Вернул?
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>25
   </td>
   <td>Мск
   </td>
   <td>70000
   </td>
   <td>A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>31
   </td>
   <td>Мск
   </td>
   <td>?
   </td>
   <td>C
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>10
   </td>
   <td>Мск
   </td>
   <td>40000
   </td>
   <td>C
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>Пр
   </td>
   <td>28
   </td>
   <td>СПб
   </td>
   <td>80000
   </td>
   <td>B
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>23
   </td>
   <td>Пр
   </td>
   <td>40000
   </td>
   <td>A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>30
   </td>
   <td>
    Екб
   </td>
   <td>19973
   </td>
   <td>B
   </td>
   <td>1
   </td>
  </tr>
</table>

Еще один способ заполнения пропусков - случайными значениями из распределения данного признака:

<table>
  <tr>
   <td>Пол
   </td>
   <td>Возраст
   </td>
   <td>Город
   </td>
   <td>Доход
   </td>
   <td>Образование
   </td>
   <td>Вернул?
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>25
   </td>
   <td>Мск
   </td>
   <td>70000
   </td>
   <td>A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>31
   </td>
   <td>Мск
   </td>
   <td>?
   </td>
   <td>C
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>10
   </td>
   <td>Мск
   </td>
   <td>40000
   </td>
   <td>C
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>28
   </td>
   <td>СПб
   </td>
   <td>80000
   </td>
   <td>B
   </td>
   <td>0
   </td>
  </tr>
  <tr>
   <td>
    М
   </td>
   <td>23
   </td>
   <td>Екб
   </td>
   <td>40000
   </td>
   <td>A
   </td>
   <td>1
   </td>
  </tr>
  <tr>
   <td>Ж
   </td>
   <td>30
   </td>
   <td>
    Екб
   </td>
   <td>19973
   </td>
   <td>B
   </td>
   <td>1
   </td>
  </tr>
</table>

#### Контрольные вопросы

1. Какие основные проблемы в датасете из лабораторной вы обнаружили?
2. Каковы основные методы заполнения пропущенных значений в данных?
3. Какие существуют методы обнаружения аномальных значений в числовых признаках?

#### Дополнительные задания

1. Постройте модель регрессии для цены автомобиля. Обучите ее на данных, полученных из исходного датасета с применением разных методов заполнения пропущенных значений. Сделайте вывод об эффективности разных методов.
